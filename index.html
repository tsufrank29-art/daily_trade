<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>我的交易日誌 Demo</title>
  <style>
    :root {
      --bg: #f5f6f8;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #2563eb;
      --positive: #16a34a;
      --negative: #dc2626;
      --border: #e5e7eb;
      --shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
      --radius: 14px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: #fff;
    }
    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }
    main {
      flex: 1;
      background: var(--bg);
      padding: 28px 32px 48px;
    }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #e5e7eb;
      color: var(--text);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .btn:hover {
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.1);
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
    }
    .btn-outline {
      background: #fff;
      border: 1px solid var(--border);
    }
    .landing {
      margin: 80px auto;
      max-width: 480px;
      text-align: center;
      background: #fff;
      border-radius: var(--radius);
      padding: 48px 32px;
      box-shadow: var(--shadow);
    }
    .landing h2 {
      margin: 0 0 12px;
      font-size: 24px;
    }
    .landing p {
      margin: 0 0 24px;
      color: var(--muted);
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .tab {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .tab.active {
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 600;
      background: #eff6ff;
    }
    .summary {
      font-size: 14px;
      color: var(--muted);
      margin-left: 10px;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
    }
    .cards {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px 20px;
      box-shadow: var(--shadow);
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .card-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .date {
      font-size: 12px;
      color: var(--muted);
    }
    .stock {
      font-size: 18px;
      font-weight: 700;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: #e0f2fe;
      color: #0369a1;
      font-weight: 600;
    }
    .tag.exit {
      background: #fee2e2;
      color: #b91c1c;
    }
    .meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      font-size: 13px;
    }
    .meta .label {
      color: var(--muted);
      font-size: 12px;
    }
    .meta .value {
      font-weight: 600;
      margin-top: 4px;
    }
    .pnl.positive {
      color: var(--positive);
    }
    .pnl.negative {
      color: var(--negative);
    }
    .note {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .menu-trigger {
      border: none;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
    }
    .menu {
      position: absolute;
      top: 44px;
      right: 18px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow);
      display: none;
      flex-direction: column;
      min-width: 120px;
      z-index: 2;
    }
    .menu button {
      border: none;
      background: transparent;
      padding: 10px 14px;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }
    .menu button:hover {
      background: #f3f4f6;
    }
    .menu.open {
      display: flex;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10;
    }
    .modal.open {
      display: flex;
    }
    .dialog {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      width: min(560px, 92vw);
      box-shadow: var(--shadow);
      max-height: 90vh;
      overflow-y: auto;
    }
    .dialog h3 {
      margin: 0 0 16px;
    }
    .form-grid {
      display: grid;
      gap: 14px;
    }
    label {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    input,
    textarea {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 18px;
    }
    .helper {
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 720px) {
      header,
      main {
        padding-left: 20px;
        padding-right: 20px;
      }
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-group {
        justify-content: space-between;
      }
      .dialog {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1 id="homeTitle">我的交易日誌</h1>
      <div class="header-actions" id="headerActions"></div>
    </header>

    <main>
      <section id="app">
        <div class="toolbar">
          <div class="tabs">
            <button class="tab active" data-tab="journal">交易日誌</button>
            <button class="tab" data-tab="plan">進出場規劃</button>
            <span class="summary" id="pnlSummary">已實現損益總計：0</span>
          </div>
          <div class="filter-group">
            <select id="dateFilter">
              <option value="all">全部</option>
              <option value="7">近一週</option>
              <option value="30">近一個月</option>
              <option value="90">近三個月</option>
            </select>
            <button class="btn btn-primary" id="primaryCta">新增交易紀錄</button>
          </div>
        </div>
        <div class="cards" id="cardList"></div>
      </section>
    </main>
  </div>

  <div class="modal" id="tradeModal" data-modal>
    <div class="dialog">
      <h3 id="tradeTitle">新增交易紀錄</h3>
      <form id="tradeForm" class="form-grid"></form>
      <div class="dialog-actions">
        <button type="button" class="btn btn-outline" data-close>取消</button>
        <button type="submit" form="tradeForm" class="btn btn-primary">送出</button>
      </div>
    </div>
  </div>

  <div class="modal" id="planModal" data-modal>
    <div class="dialog">
      <h3 id="planTitle">新增進出場規劃</h3>
      <form id="planForm" class="form-grid"></form>
      <div class="dialog-actions">
        <button type="button" class="btn btn-outline" data-close>取消</button>
        <button type="submit" form="planForm" class="btn btn-primary">送出</button>
      </div>
    </div>
  </div>

  <script>
    const state = {
      nickname: "交易者",
      activeTab: "journal",
      filterDays: "all",
      tradeEditingId: null,
      planEditingId: null,
      trades: [],
      plans: [],
      nextId: 1,
    };

    const headerActions = document.getElementById("headerActions");
    const app = document.getElementById("app");
    const cardList = document.getElementById("cardList");
    const pnlSummary = document.getElementById("pnlSummary");
    const primaryCta = document.getElementById("primaryCta");
    const dateFilter = document.getElementById("dateFilter");

    const tradeModal = document.getElementById("tradeModal");
    const tradeTitle = document.getElementById("tradeTitle");
    const tradeForm = document.getElementById("tradeForm");

    const planModal = document.getElementById("planModal");
    const planTitle = document.getElementById("planTitle");
    const planForm = document.getElementById("planForm");

    const formatDate = (date) => {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, "0");
      const dd = String(date.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    };

    const displayDate = (iso) => iso.replace(/-/g, "/");

    const daysAgo = (days) => {
      const date = new Date();
      date.setDate(date.getDate() - days);
      return formatDate(date);
    };

    const seedData = () => {
      state.trades = [
        {
          id: state.nextId++,
          date: daysAgo(2),
          symbol: "2330",
          name: "台積電",
          type: "entry",
          entryPrice: 595.5,
          exitPrice: null,
          shares: 10,
          pnl: null,
          note: "分批進場，等待突破量能確認。",
        },
        {
          id: state.nextId++,
          date: daysAgo(20),
          symbol: "0050",
          name: "元大台灣50",
          type: "exit",
          entryPrice: 142.2,
          exitPrice: 148.4,
          shares: 5,
          pnl: 3100,
          note: "達標停利，符合原先規劃。",
        },
        {
          id: state.nextId++,
          date: daysAgo(70),
          symbol: "2454",
          name: "聯發科",
          type: "exit",
          entryPrice: 980.0,
          exitPrice: 950.5,
          shares: 3,
          pnl: -8850,
          note: "跌破支撐，停損出場。",
        },
      ];
      state.plans = [
        {
          id: state.nextId++,
          date: daysAgo(6),
          symbol: "3037",
          name: "欣興",
          target: 125.5,
          entryRule: "站上月線且量能放大",
          exitRule: "接近前高或跌破 5 日線",
          note: "觀察外資買盤變化。",
        },
        {
          id: state.nextId++,
          date: daysAgo(40),
          symbol: "2603",
          name: "長榮",
          target: 180.0,
          entryRule: "突破箱型上緣",
          exitRule: "跌破季線或達到目標價",
          note: "短線波動大，注意風險控管。",
        },
      ];
    };

    const resetView = () => {
      state.activeTab = "journal";
      state.filterDays = "all";
      dateFilter.value = "all";
      closeAllModals();
      render();
    };

    const renderHeader = () => {
      headerActions.innerHTML = "";
      const greet = document.createElement("span");
      greet.textContent = `Hi, ${state.nickname || "交易者"}`;
      headerActions.append(greet);
    };

    const filteredByDate = (items) => {
      if (state.filterDays === "all") return items;
      const days = Number(state.filterDays);
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      return items.filter((item) => new Date(item.date) >= cutoff);
    };

    const renderSummary = () => {
      const total = state.trades
        .filter((trade) => trade.type === "exit" && typeof trade.pnl === "number")
        .reduce((sum, trade) => sum + trade.pnl, 0);
      const sign = total > 0 ? "+" : total < 0 ? "" : "";
      pnlSummary.textContent = `已實現損益總計：${sign}${total.toLocaleString()}`;
    };

    const createMenu = (id, type) => {
      const menu = document.createElement("div");
      menu.className = "menu";
      const edit = document.createElement("button");
      edit.textContent = "編輯";
      edit.addEventListener("click", () => {
        closeMenus();
        if (type === "trade") openTradeModal(id);
        if (type === "plan") openPlanModal(id);
      });
      const del = document.createElement("button");
      del.textContent = "刪除";
      del.addEventListener("click", () => {
        closeMenus();
        if (!confirm("確定要刪除嗎？")) return;
        if (type === "trade") {
          state.trades = state.trades.filter((item) => item.id !== id);
        } else {
          state.plans = state.plans.filter((item) => item.id !== id);
        }
        render();
      });
      menu.append(edit, del);
      return menu;
    };

    const closeMenus = () => {
      document.querySelectorAll(".menu.open").forEach((menu) => menu.classList.remove("open"));
    };

    const renderCards = () => {
      cardList.innerHTML = "";
      const items = state.activeTab === "journal" ? state.trades : state.plans;
      const filtered = filteredByDate(items).slice().sort((a, b) => new Date(b.date) - new Date(a.date));

      if (filtered.length === 0) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.textContent = "尚無符合條件的資料。";
        cardList.append(empty);
        return;
      }

      filtered.forEach((item) => {
        const card = document.createElement("div");
        card.className = "card";

        const header = document.createElement("div");
        header.className = "card-header";

        const title = document.createElement("div");
        title.className = "card-title";
        const date = document.createElement("span");
        date.className = "date";
        date.textContent = displayDate(item.date);
        const stock = document.createElement("span");
        stock.className = "stock";
        stock.textContent = `${item.name} (${item.symbol})`;
        title.append(date, stock);

        const menuWrap = document.createElement("div");
        const trigger = document.createElement("button");
        trigger.className = "menu-trigger";
        trigger.type = "button";
        trigger.textContent = "⋯";
        const menu = createMenu(item.id, state.activeTab === "journal" ? "trade" : "plan");
        trigger.addEventListener("click", (event) => {
          event.stopPropagation();
          const isOpen = menu.classList.contains("open");
          closeMenus();
          menu.classList.toggle("open", !isOpen);
        });
        menuWrap.append(trigger, menu);

        header.append(title, menuWrap);

        const meta = document.createElement("div");
        meta.className = "meta";

        if (state.activeTab === "journal") {
          const typeTag = document.createElement("span");
          typeTag.className = `tag ${item.type === "exit" ? "exit" : ""}`;
          typeTag.textContent = item.type === "exit" ? "出場" : "進場";

          const typeField = document.createElement("div");
          typeField.innerHTML = `<div class="label">交易類型</div>`;
          typeField.append(typeTag);

          const priceLabel = item.type === "exit" ? "出場均價" : "進場均價";
          const priceValue = item.type === "exit" ? item.exitPrice : item.entryPrice;

          meta.append(
            typeField,
            createMeta("均價", priceValue?.toFixed(2) ?? "-", priceLabel),
            createMeta("張數", item.shares, "張數"),
          );

          if (item.type === "exit") {
            const pnlValue = item.pnl ?? 0;
            const pnl = document.createElement("div");
            pnl.innerHTML = `<div class="label">已實現損益</div>`;
            const value = document.createElement("div");
            value.className = `value pnl ${pnlValue >= 0 ? "positive" : "negative"}`;
            value.textContent = `${pnlValue > 0 ? "+" : ""}${pnlValue.toLocaleString()}`;
            pnl.append(value);
            meta.append(pnl);
          }
        } else {
          meta.append(
            createMeta("目標價", item.target.toFixed(2), "目標價"),
            createMeta("進場條件", item.entryRule, "進場條件"),
            createMeta("出場條件", item.exitRule, "出場條件"),
          );
        }

        const note = document.createElement("div");
        note.className = "note";
        note.textContent = item.note || "-";

        card.append(header, meta, note);
        cardList.append(card);
      });
    };

    const createMeta = (label, value, aria) => {
      const wrap = document.createElement("div");
      wrap.setAttribute("aria-label", aria);
      const labelEl = document.createElement("div");
      labelEl.className = "label";
      labelEl.textContent = label;
      const valueEl = document.createElement("div");
      valueEl.className = "value";
      valueEl.textContent = value ?? "-";
      wrap.append(labelEl, valueEl);
      return wrap;
    };

    const render = () => {
      renderHeader();
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.tab === state.activeTab);
      });
      primaryCta.textContent = state.activeTab === "journal" ? "新增交易紀錄" : "新增進出場規劃";
      renderSummary();
      renderCards();
    };

    const openTradeModal = (id = null) => {
      state.tradeEditingId = id;
      const editing = state.trades.find((item) => item.id === id);
      tradeTitle.textContent = id ? "編輯交易紀錄" : "新增交易紀錄";
      tradeForm.innerHTML = `
        <label>日期
          <input type="date" name="date" required />
        </label>
        <label>股票代號
          <input type="text" name="symbol" required />
        </label>
        <label>股票名稱
          <input type="text" name="name" required />
        </label>
        <label>交易類型
          <select name="type">
            <option value="entry">進場</option>
            <option value="exit">出場</option>
          </select>
        </label>
        <label data-field="entryPrice">進場均價
          <input type="number" step="0.01" name="entryPrice" />
        </label>
        <label data-field="exitPrice">出場均價
          <input type="number" step="0.01" name="exitPrice" />
        </label>
        <label>張數
          <input type="number" name="shares" required />
        </label>
        <label data-field="pnl">已實現損益
          <input type="number" step="0.01" name="pnl" />
        </label>
        <label>備註
          <textarea name="note"></textarea>
        </label>
      `;
      const formData = {
        date: editing?.date ?? formatDate(new Date()),
        symbol: editing?.symbol ?? "",
        name: editing?.name ?? "",
        type: editing?.type ?? "entry",
        entryPrice: editing?.entryPrice ?? "",
        exitPrice: editing?.exitPrice ?? "",
        shares: editing?.shares ?? "",
        pnl: editing?.pnl ?? "",
        note: editing?.note ?? "",
      };
      Object.entries(formData).forEach(([key, value]) => {
        const input = tradeForm.elements[key];
        if (input) input.value = value;
      });
      const updateFields = () => {
        const type = tradeForm.elements.type.value;
        tradeForm.querySelector('[data-field="entryPrice"]').style.display = type === "entry" ? "block" : "none";
        tradeForm.querySelector('[data-field="exitPrice"]').style.display = type === "exit" ? "block" : "none";
        tradeForm.querySelector('[data-field="pnl"]').style.display = type === "exit" ? "block" : "none";
      };
      tradeForm.elements.type.addEventListener("change", updateFields);
      updateFields();
      tradeForm.onsubmit = (event) => {
        event.preventDefault();
        const data = new FormData(tradeForm);
        const payload = {
          id: editing?.id ?? state.nextId++,
          date: data.get("date"),
          symbol: data.get("symbol"),
          name: data.get("name"),
          type: data.get("type"),
          entryPrice: data.get("entryPrice") ? Number(data.get("entryPrice")) : null,
          exitPrice: data.get("exitPrice") ? Number(data.get("exitPrice")) : null,
          shares: Number(data.get("shares")),
          pnl: data.get("pnl") ? Number(data.get("pnl")) : null,
          note: data.get("note"),
        };
        if (editing) {
          state.trades = state.trades.map((item) => (item.id === editing.id ? payload : item));
        } else {
          state.trades.unshift(payload);
        }
        closeAllModals();
        render();
      };
      openModal(tradeModal);
    };

    const openPlanModal = (id = null) => {
      state.planEditingId = id;
      const editing = state.plans.find((item) => item.id === id);
      planTitle.textContent = id ? "編輯進出場規劃" : "新增進出場規劃";
      planForm.innerHTML = `
        <label>日期
          <input type="date" name="date" required />
        </label>
        <label>股票代號
          <input type="text" name="symbol" required />
        </label>
        <label>股票名稱
          <input type="text" name="name" required />
        </label>
        <label>目標價
          <input type="number" step="0.01" name="target" required />
        </label>
        <label>進場條件
          <textarea name="entryRule"></textarea>
        </label>
        <label>出場條件
          <textarea name="exitRule"></textarea>
        </label>
        <label>備註
          <textarea name="note"></textarea>
        </label>
      `;
      const formData = {
        date: editing?.date ?? formatDate(new Date()),
        symbol: editing?.symbol ?? "",
        name: editing?.name ?? "",
        target: editing?.target ?? "",
        entryRule: editing?.entryRule ?? "",
        exitRule: editing?.exitRule ?? "",
        note: editing?.note ?? "",
      };
      Object.entries(formData).forEach(([key, value]) => {
        const input = planForm.elements[key];
        if (input) input.value = value;
      });
      planForm.onsubmit = (event) => {
        event.preventDefault();
        const data = new FormData(planForm);
        const payload = {
          id: editing?.id ?? state.nextId++,
          date: data.get("date"),
          symbol: data.get("symbol"),
          name: data.get("name"),
          target: Number(data.get("target")),
          entryRule: data.get("entryRule"),
          exitRule: data.get("exitRule"),
          note: data.get("note"),
        };
        if (editing) {
          state.plans = state.plans.map((item) => (item.id === editing.id ? payload : item));
        } else {
          state.plans.unshift(payload);
        }
        closeAllModals();
        render();
      };
      openModal(planModal);
    };

    const openModal = (modal) => {
      modal.classList.add("open");
    };

    const closeAllModals = () => {
      document.querySelectorAll(".modal.open").forEach((modal) => modal.classList.remove("open"));
      state.tradeEditingId = null;
      state.planEditingId = null;
    };

    document.addEventListener("click", () => closeMenus());
    document.querySelectorAll("[data-close]").forEach((btn) => {
      btn.addEventListener("click", closeAllModals);
    });
    document.querySelectorAll(".modal").forEach((modal) => {
      modal.addEventListener("click", (event) => {
        if (event.target === modal) closeAllModals();
      });
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") closeAllModals();
    });

    document.getElementById("homeTitle").addEventListener("click", resetView);

    document.querySelectorAll(".tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        state.activeTab = tab.dataset.tab;
        render();
      });
    });

    dateFilter.addEventListener("change", (event) => {
      state.filterDays = event.target.value;
      render();
    });

    primaryCta.addEventListener("click", () => {
      if (state.activeTab === "journal") {
        openTradeModal();
      } else {
        openPlanModal();
      }
    });

    seedData();
    render();
  </script>
</body>
</html>
